services:

  #Banco postgresql
  postgresql:
    image: postgres:16
    ports:
      - '5432:5432'
    environment:
      POSTGRES_DB: bank_user
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
    restart: always
    volumes:
      - postgres-data:/var/lib/postgresql/data

  #Eureka Server
  eureka-server:
    image: steeltoeoss/eureka-server:latest
    ports:
      - "8761:8761"
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://localhost:8761/eureka
      - EUREKA_CLIENT_FETCH_REGISTRY=true
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=true
    restart: always

  # Kafka
  kafka-server:
    image: bitnamilegacy/kafka:latest
    ports:
      - "9092:9092"
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-server:9092"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka-server:9093"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
      ALLOW_PLAINTEXT_LISTENER: "yes"
    volumes:
      - kafka-data:/var/lib/kafka/data
    restart: always


  # Microservi√ßos

  #BANK-USER
  bank-user:
    build: ./bank-user
    ports:
      - "8080:8080"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_user
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092
      
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always


  #BANK-DOCUMENT
  bank-document:
    build: ./bank-document
    ports:
      - "8081:8081"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_document
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always
    

  #BANK-THEFT
  bank-theft:
    build: ./bank-theft
    ports:
      - "8082:8082"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_theft
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always


  #BANK-CARD
  bank-card:
    build: ./bank-card
    ports:
      - "8083:8083"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_card
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always


  
  #BANK-NOTIFICATION
  bank-notification:
    build: ./bank-notification
    ports:
      - "8084:8084"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_notification
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always


  #BANK-LOGIN
  bank-login:
    build: ./bank-login
    ports:
      - "8085:8085"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_login
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always

  
  #BANK-WALLET
  bank-wallet:
    build: ./bank-wallet
    ports:
      - "8086:8086"
    depends_on:
      - eureka-server
      - postgresql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgresql:5432/bank_wallet
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092

      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka
    restart: always


  
  #BANK-EMAIL
  email:
    build: ./email
    ports:
      - "1010:1010"
    depends_on:
      - eureka-server
    environment:
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka

      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka-server:9092
    restart: always


volumes:
  postgres-data:
  kafka-data:

networks:
  public:
  private: